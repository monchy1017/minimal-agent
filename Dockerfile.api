# ---- Build Stage ----
FROM python:3.13-slim AS builder

# uvをインストール
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /app

# 依存関係ファイルをコピーしてインストール
COPY pyproject.toml uv.lock ./
RUN uv venv
RUN uv pip install .

# ---- Runtime Stage ----
FROM python:3.13-slim

WORKDIR /app

# 仮想環境をビルドステージからコピー
COPY --from=builder /app/.venv /app/.venv

# アプリケーションコードをコピー（APIに必要なファイルのみ）
COPY agent.py api.py schemas.py ./

# 仮想環境のパスを優先させる
ENV PATH="/app/.venv/bin:$PATH"

# Cloud Run はデフォルトで PORT 環境変数を渡す (デフォルト 8080)
EXPOSE 8080

CMD ["/app/.venv/bin/uvicorn", "api:app", "--host", "0.0.0.0", "--port", "${PORT:-8080}"]
